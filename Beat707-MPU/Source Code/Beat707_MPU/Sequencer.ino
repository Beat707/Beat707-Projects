/*
 * 
 * Beat707 MIDI Box
 * Created by William Kalfelz @ Beat707 (c) 2017 - http://www.Beat707.com
 * 
 */

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ISR(TIMER1_COMPA_vect) 
{
  tickSequencer();
}

byte seqC = 0;
// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void tickSequencer()
{
  XSerial.writeByte(0xF8);
  seqC++;
  if (seqC > 16)
  {
    LED_Activity_On(1);
    seqC = 0;
  }
}

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void startSequencer()
{
  XSerial.writeByte(0xFA);
  startTimer();
  tickSequencer();
}

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void stopSequencer()
{
  stopTimer();
  XSerial.writeByte(0xFC);
  MIDIallNotesOff();
}

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
inline void startTimer()
{
  TCCR1A = TCCR1B = 0;
  bitWrite(TCCR1B, CS11, 1);
  bitWrite(TCCR1B, WGM12, 1);
  updateSequencerSpeed();
  bitWrite(TIMSK, OCIE1A, 1); 
}

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
inline void stopTimer()
{
  bitWrite(TIMSK, OCIE1A, 0);
  TCCR1A = TCCR1B = OCR1A = 0; 
}

#define MAX_SEQ_SPEEDS 16
const uint16_t seqSpeeds[MAX_SEQ_SPEEDS] = { 49999, 41666, 35713, 31249, 27777, 24999, 22726, 20832, 19230, 17856, 16666, 15624, 14705, 13888, 13157, 12499 }; // 50 ~ 200 BPM //
// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
void updateSequencerSpeed()
{
  OCR1A = seqSpeeds[globalVars[kSequencer_Glob_BPM]];
}

// --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
inline void MIDIallNotesOff()
{
  for (byte x=0; x<16; x++)
  {
    XSerial.writeByte(0xB0+x);
    XSerial.writeByte(0x7B);
    XSerial.writeByte((byte)0x00);
  }
}
